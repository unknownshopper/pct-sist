<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Registro de Pre-Post Trabajos y Recepción de Equipos</title>
  <link rel="stylesheet" href="styles.css" />
  <style>
    main { position: relative; max-width: 1800px; margin: 0 auto; padding-left: 12px; padding-right: 12px; }
    /* Auth gate */
    body.locked main { filter: blur(4px); pointer-events: none; user-select: none; }
    .lock-overlay { position: fixed; inset: 0; display: none; align-items: center; justify-content: center; padding: 24px; background: rgba(15,23,42,0.35); backdrop-filter: blur(2px); z-index: 50; }
    body.locked .lock-overlay { display: flex; }
    .lock-card { width: 100%; max-width: 520px; background: #fff; border: 1px solid var(--steel-400); border-radius: 14px; padding: 22px; box-shadow: var(--shadow); text-align: center; }
    .field { display: flex; gap: 8px; align-items: center; margin: 8px 0; }
    .field input { flex: 1; height: 40px; border: 1px solid var(--steel-400); border-radius: 10px; padding: 8px 10px; font: inherit; }
    .auth-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
    .filters { display: grid; grid-template-columns: repeat(3, minmax(0, 1fr)); gap: 10px; margin: 10px 0 16px; }
    .filters select, .filters input { height: 38px; border: 1px solid var(--steel-400); border-radius: 10px; padding: 6px 10px; font: inherit; }
    .table-wrap { overflow: auto; border: 1px solid var(--steel-400); border-radius: 10px; background: #fff; }
    table.list { width: 100%; border-collapse: collapse; min-width: 1200px; }
    table.list th, table.list td { padding: 10px 12px; border-bottom: 1px solid rgba(15,23,42,0.08); text-align: left; }
    table.list thead th { position: sticky; top: 0; background: var(--bg-800); z-index: 1; }
    .pill { display: inline-block; padding: 4px 8px; border-radius: 999px; border: 1px solid rgba(2, 132, 199, 0.25); font-weight: 600; color: var(--text-300); background: #fff; }
    .pill.ok { border-color: rgba(16,185,129,.35); color: #065f46; background: rgba(16,185,129,.1); }
    .pill.bad { border-color: rgba(239,68,68,.35); color: #7f1d1d; background: rgba(239,68,68,.1); }
    /* Navbar */
    .topbar { position: sticky; top: 0; display: flex; align-items: center; gap: 12px; padding: 10px 14px; background:#fff; border-bottom:1px solid var(--steel-300); z-index: 40; }
    .brand { font-weight: 800; color: var(--accent); text-decoration: none; }
    .nav-toggle { margin-left: auto; display: none; background: transparent; border: 1px solid var(--steel-400); padding: 6px 10px; border-radius: 8px; }
    .nav-links { list-style: none; display: flex; gap: 12px; margin: 0; padding: 0; flex-wrap: wrap; }
    .nav-links a { text-decoration: none; color: var(--text-200); font-weight: 600; padding: 6px 8px; border-radius: 8px; }
    .nav-links a[aria-current="page"] { background: rgba(11,179,217,0.08); color: var(--accent); }
    .user-badge { position: relative; right: 0; top: 0; margin-left: auto; display: none; align-items: center; gap: 8px; padding: 6px 10px; border: 1px solid rgba(2,132,199,0.25); border-radius: 999px; background: #fff; color: var(--text-300); font-weight: 600; }
    .user-avatar { width: 20px; height: 20px; border-radius: 50%; background: linear-gradient(135deg, var(--accent-2), var(--accent)); }
    .user-menu { position: absolute; right: 0; top: calc(100% + 6px); display: none; min-width: 180px; background:#fff; border:1px solid var(--steel-400); border-radius: 10px; box-shadow: var(--shadow); padding: 6px; }
    .user-menu a, .user-menu button { width: 100%; display: block; text-align: left; padding: 8px 10px; border: none; background: none; color: var(--text-200); text-decoration: none; border-radius: 8px; cursor: pointer; }
    .user-menu a:hover, .user-menu button:hover { background: rgba(2,132,199,0.08); }
    .user-badge.open .user-menu { display: block; }
    @media (max-width: 760px) { .nav-toggle { display: inline-block; } .nav-links { position: absolute; left:0; right:0; top:54px; background:#fff; border-bottom:1px solid var(--steel-300); display:none; flex-direction:column; padding:8px; } .nav-links.open { display:flex; } }
    .btn { appearance: none; border: 1px solid var(--steel-400); background: #fff; color: var(--text-100); padding: 8px 12px; border-radius: 10px; font-weight: 600; cursor: pointer; }
    .btn:hover { border-color: rgba(2,132,199,0.35); box-shadow: 0 6px 16px rgba(2,132,199,0.08); }
    .muted { color: var(--muted); }
    @media (max-width: 768px) {
      .filters { grid-template-columns: 1fr; }
    }
  </style>
  <script>
    function getEvaluation(meta){
      try {
        var v = (meta && (meta.evaluation || meta.eval || meta.status || meta.resultado)) || '';
        v = String(v).trim().toLowerCase();
        if (!v) return '';
        // New labels
        if (v === 'operativo' || v === 'ok' || v === 'accept' || v === 'accepted' || v === 'aceptado' || v === 'aceptada' || v === 'aprobado' || v === 'aprobada') return 'Operativo';
        if (v === 'no operativo' || v === 'no_operativo' || v === 'rechazado' || v === 'rechazada' || v === 'fail' || v === 'rejected' || v === 'no aceptado' || v === 'no_aplica_malo') return 'No operativo';
        return (v && v !== 'operativo') ? 'No operativo' : 'Operativo';
      } catch { return ''; }
    }
    function fmtIdFromDate(d){
      try {
        var dateObj = null;
        if (d && typeof d.toDate === 'function') { dateObj = d.toDate(); }
        else if (typeof d === 'string') { dateObj = new Date(d); }
        else if (d instanceof Date) { dateObj = d; }
        if (!dateObj || isNaN(dateObj.getTime())) return '';
        var yyyy = dateObj.getFullYear();
        var mm = String(dateObj.getMonth()+1).padStart(2,'0');
        var dd = String(dateObj.getDate()).padStart(2,'0');
        var hh = String(dateObj.getHours()).padStart(2,'0');
        var mi = String(dateObj.getMinutes()).padStart(2,'0');
        return yyyy+mm+dd+'-'+hh+mi;
      } catch { return ''; }
    }

    function getProductFromMeta(meta){
      try {
        var prodRaw = (meta && (meta.producto || meta.product || meta.tipo1)) || '';
        if (prodRaw && prodRaw !== '—') return String(prodRaw);
        // Fallback: derivar del snapshot de inventario adjunto en meta.inv
        var inv = meta && meta.inv;
        if (inv && Array.isArray(inv.headers) && Array.isArray(inv.row)){
          var headers = inv.headers.map(function(h){ return String(h||'').trim(); });
          var row = inv.row;
          var idxProducto = headers.findIndex(function(h){ return /^Producto$/i.test(h); });
          if (idxProducto < 0) {
            idxProducto = headers.findIndex(function(h){ return /^TIPO$/i.test(h); });
            if (idxProducto < 0 && headers.length > 4) idxProducto = 4;
          }
          if (idxProducto >= 0) {
            var v = row[idxProducto] || '';
            if (v && v !== '—') return String(v);
          }
        }
        return '';
      } catch { return ''; }
    }

    function populateProductSelect(items){
      var sel = document.getElementById('fProducto');
      if (!sel) return;
      var existing = {};
      for (var i=0;i<items.length;i++){
        var m = items[i].meta || {};
        var p = getProductFromMeta(m);
        if ((!p || p==='') && window.invProductoMap && items[i].itemKey){ p = window.invProductoMap[items[i].itemKey] || ''; }
        if (p) existing[p] = true;
      }
      var list = Object.keys(existing).sort(function(a,b){ return a.localeCompare(b,'es',{sensitivity:'base'}); });
      var current = sel.value || '';
      var firstText = sel.options.length ? sel.options[0].textContent : 'Producto (todos)';
      sel.innerHTML = '';
      var opt0 = document.createElement('option'); opt0.value = ''; opt0.textContent = firstText; sel.appendChild(opt0);
      for (var j=0;j<list.length;j++){ var o=document.createElement('option'); o.value=list[j]; o.textContent=list[j]; sel.appendChild(o); }
      if (current && existing[current]) sel.value = current;
    }
  </script>
</head>
<body>
  <nav class="topbar" aria-label="Principal">
    <a class="brand" href="primaria.html">PCT</a>
    <button id="navToggle" class="nav-toggle" aria-expanded="false" aria-controls="navMenu" aria-label="Abrir menú">☰</button>
    <ul id="navMenu" class="nav-links">
      <li><a href="primaria.html">Primaria</a></li>
      <li><a href="inslis.html" aria-current="page">Registro</a></li>
      <li><a href="intop.html">Aproximaciones</a></li>
      <li><a href="ingral.html">Inventario</a></li>
      <li><a href="tareas.html">Tareas</a></li>
      <li><a href="pct2.html">PCT2</a></li>
      <li><a href="index.html">Admin</a></li>
      <li><a href="opciones.html">Opciones</a></li>
    </ul>
    <div id="userBadge" class="user-badge" style="display:none">
      <div class="user-avatar"></div>
      <span id="userName">Usuario</span>
      <div class="user-menu" id="userMenu" role="menu" aria-hidden="true">
        <a href="opciones.html" role="menuitem">Opciones</a>
        <button id="logoutMenuItem" type="button" role="menuitem">Cerrar sesión</button>
      </div>
    </div>
  </nav>
  <main>
    <h1>Registro de Pre-Post Trabajos y Recepción de Equipos</h1>
    <p class="accent-left">Listado consolidado de inspecciones guardadas en Firestore.</p>

    <div class="filters">
      <select id="fProducto">
        <option value="">Producto (todos)</option>
        <option value="codo">Codo</option>
        <option value="t1">Tubería 1</option>
        <option value="t2">Tubería 2</option>
      </select>
      <select id="fEval">
        <option value="">Evaluación (todas)</option>
        <option>Operativo</option>
        <option>No operativo</option>
      </select>
      <input id="fTexto" type="search" placeholder="Buscar por usuario, ID o ubicación" />
      <span style="display:flex; gap:8px; align-items:center; justify-content:flex-end">
        <button id="btnExportAllCSV" class="btn" type="button">Exportar CSV (todo)</button>
        <button id="btnExportAllPDF" class="btn" type="button">Exportar PDF (todo)</button>
      </span>
    </div>

    <div class="table-wrap">
      <table class="list">
        <thead>
          <tr>
            <th>Fecha</th>
            <th>Equipo/Activo</th>
            <th>Producto</th>
            <th>Evaluación</th>
            <th>Ubicación</th>
            <th>Usuario</th>
            <th>Inspección</th>
            <th>Origen</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody id="rows">
          <tr><td colspan="9" class="muted">Cargando…</td></tr>
        </tbody>
      </table>
    </div>
  </main>

  <script src="firebase-config.js"></script>
  <script src="script.js?v=3"></script>
  <script>
    window.firebaseConfig = window.firebaseConfig || {
      apiKey: "AIzaSyCaG3KkC5q0VhNDfelH3OTTC0Qrpf7PRs4",
      authDomain: "pct-checklist.firebaseapp.com",
      projectId: "pct-checklist",
      storageBucket: "pct-checklist.firebasestorage.app",
      messagingSenderId: "573177765621",
      appId: "1:573177765621:web:7f7d58915121440cebefbc"
    };
  </script>
  <script type="module">
    import { getDocs, getDoc, query, orderBy, collection, collectionGroup, onSnapshot, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // Wait for firebase-init to attach window.db and auth helpers
    async function ready() {
      const maxTries = 60; // ~3s
      for (let i=0; i<maxTries; i++){
        if (window.db) return true;
        await new Promise(r => setTimeout(r, 50));
      }
      return !!window.db;
    }

    function $(s, c=document){ return c.querySelector(s); }
    function $all(s, c=document){ return Array.from(c.querySelectorAll(s)); }

    function bindAuth(){
      // navbar and overlay handled globally by script.js
      window.addEventListener('auth:changed', (e) => {
        const user = (e && e.detail && e.detail.user) ? e.detail.user : null;
        const badge = document.getElementById('userBadge');
        const name = document.getElementById('userName');
        if (user){ if (badge) badge.style.display = 'flex'; if (name) name.textContent = user.displayName || user.email || user.uid; }
        else { if (badge) badge.style.display = 'none'; }
      });
      // aplicar estado actual si ya hay sesión
      try {
        const u = window.currentUser || null;
        const badge = document.getElementById('userBadge');
        const name = document.getElementById('userName');
        if (u){ if (badge) badge.style.display = 'flex'; if (name) name.textContent = u.displayName || u.email || u.uid; }
      } catch {}
    }

    function fmtDate(d){
      try {
        var dateObj = null;
        if (d && typeof d.toDate === 'function') { dateObj = d.toDate(); }
        else if (typeof d === 'string') { dateObj = new Date(d); }
        else if (d instanceof Date) { dateObj = d; }
        if (!dateObj || isNaN(dateObj.getTime())) return '';
        var dd = String(dateObj.getDate()).padStart(2,'0');
        var mm = String(dateObj.getMonth()+1).padStart(2,'0');
        var yyyy = dateObj.getFullYear();
        var hh = String(dateObj.getHours()).padStart(2,'0');
        var mi = String(dateObj.getMinutes()).padStart(2,'0');
        return dd + '/' + mm + '/' + yyyy + ' ' + hh + ':' + mi;
      } catch { return ''; }
    }

    function renderRows(items){
      const tbody = $('#rows');
      if (!tbody) return;
      tbody.innerHTML = '';
      if (!items.length){
        tbody.innerHTML = '<tr><td class="muted" colspan="9">Sin inspecciones</td></tr>';
        return;
      }
      for (const it of items){
        const tr = document.createElement('tr');
        const meta = it.meta || {};
        const user = meta.user || {};
        const geo = meta.geo || {};
        const fecha = meta.createdAtLocal ? fmtDate(meta.createdAtLocal) : fmtDate(it.createdAt || '');
        const equipoActivo = getEquipoActivo(meta, it);
        let producto = (window.getProductFromMeta ? window.getProductFromMeta(meta) : ((meta.producto||meta.product||meta.tipo1||'')==='—'?'':(meta.producto||meta.product||meta.tipo1||'')));
        if (!producto) { producto = resolveProductoFromInventory(meta, it); }
        const evalv = getEvaluation(meta) || '';
        const ubic = (geo.lat && geo.lng) ? (String(geo.lat.toFixed(5)) + ', ' + String(geo.lng.toFixed(5))) : '';
        const inspId = (window.fmtIdFromDate ? window.fmtIdFromDate(meta.createdAtLocal || it.createdAt || '') : '') || (meta.inspectionId || it.id);
        tr.innerHTML = ''
          + '<td>' + (fecha || '') + '</td>'
          + '<td>' + (equipoActivo || '') + '</td>'
          + '<td>' + (producto || '') + '</td>'
          + '<td>' + (evalv ? ('<span class="pill ' + (evalv==='Operativo'?'ok':'bad') + '">' + evalv + '</span>') : '') + '</td>'
          + '<td>' + ubic + '</td>'
          + '<td>' + (user.displayName || user.email || '') + '</td>'
          + '<td>' + (inspId || '') + '</td>'
          + '<td>' + (it.origin || '') + '</td>'
          + '<td>'
            + '<button class="btn btn-small" data-view-id="' + it.id + '">Ver</button> '
            + '<button class="btn btn-small" data-edit-id="' + it.id + '">Editar</button> '
            + '<button class="btn btn-small" data-del-id="' + it.id + '">Eliminar</button> '
            + '<button class="btn btn-small" data-csv-id="' + it.id + '">CSV</button> '
            + '<button class="btn btn-small" data-pdf-id="' + it.id + '">PDF</button>'
          + '</td>';
        tbody.appendChild(tr);
        const btnView = tr.querySelector('button[data-view-id]');
        if (btnView) btnView.addEventListener('click', function(){ (window.viewItem||viewItem)(it); });
        const btnEdit = tr.querySelector('button[data-edit-id]');
        if (btnEdit) btnEdit.addEventListener('click', function(){ editItem(it); });
        const btnDel = tr.querySelector('button[data-del-id]');
        if (btnDel) btnDel.addEventListener('click', function(){ deleteItem(it, tr); });
        const btnCsv = tr.querySelector('button[data-csv-id]');
        if (btnCsv) btnCsv.addEventListener('click', function(){ exportItemCSV(it); });
        const btnPdf = tr.querySelector('button[data-pdf-id]');
        if (btnPdf) btnPdf.addEventListener('click', function(){ exportItemPDF(it); });
      }
    }

    function applyFilters(data){
      const fp = $('#fProducto').value || '';
      const fe = $('#fEval').value || '';
      const ft = ($('#fTexto').value || '').toLowerCase();
      return data.filter(it => {
        const meta = it.meta || {}; const user = meta.user || {}; const geo = meta.geo || {};
        var prodVal = window.getProductFromMeta ? window.getProductFromMeta(meta) : ((meta.producto||meta.product||meta.tipo1||'')==='—'?'':(meta.producto||meta.product||meta.tipo1||''));
        if (!prodVal) { prodVal = resolveProductoFromInventory(meta, it); }
        if (fp && prodVal !== fp) return false;
        const ev = getEvaluation(meta) || '';
        if (fe && ev !== fe) return false;
        const hay = [prodVal, meta.inspectionId, user.displayName, user.email, ((geo.lat||'') + ',' + (geo.lng||'')), it.id].join(' ').toLowerCase();
        if (ft && !hay.includes(ft)) return false;
        return true;
      });
    }

    function bindFilters(data){
      ['fProducto','fEval','fTexto'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.addEventListener('input', () => renderRows(applyFilters(data)));
        if (el) el.addEventListener('change', () => renderRows(applyFilters(data)));
      });
      const btnAllCsv = document.getElementById('btnExportAllCSV');
      if (btnAllCsv) btnAllCsv.addEventListener('click', () => exportAllCSV(applyFilters(data)));
      const btnAllPdf = document.getElementById('btnExportAllPDF');
      if (btnAllPdf) btnAllPdf.addEventListener('click', () => exportAllPDF(applyFilters(data)));
    }

    async function loadData(){
      await ready();
      const db = window.db;
      const items = [];
      try {
        const qRoot = query(collection(db, 'inspections'), orderBy('createdAt', 'desc'));
        const snapRoot = await getDocs(qRoot);
        snapRoot.forEach(function(doc){ var data = doc.data(); items.push(Object.assign({ id: doc.id, origin: 'inspections', path: 'inspections/'+doc.id }, data)); });
      } catch {}
      try {
        const qSub = query(collectionGroup(db, 'inspections'), orderBy('createdAt', 'desc'));
        const snapSub = await getDocs(qSub);
        snapSub.forEach(function(doc){ var data = doc.data(); var ik=null; try{ ik = doc.ref.parent.parent.id; }catch{} items.push(Object.assign({ id: doc.id, origin: 'items/*/inspections', itemKey: ik, path: doc.ref.path }, data)); });
      } catch {}
      return items.sort(function(a,b){
        var bs = (b.createdAt && b.createdAt.seconds) ? b.createdAt.seconds : 0;
        var as = (a.createdAt && a.createdAt.seconds) ? a.createdAt.seconds : 0;
        return bs - as;
      });
    }

    async function subscribeData(onItems){
      await ready();
      const db = window.db;
      const map = new Map(); // key: fullPath, val: item
      const apply = () => {
        // Deduplicate by inspectionId (prefer root/origin 'inspections')
        const byInsp = new Map();
        Array.from(map.values()).forEach(function(it){
          const id = (it.meta && it.meta.inspectionId) || it.inspectionId || it.id;
          if (!id) { byInsp.set(Math.random().toString(36), it); return; }
          const prev = byInsp.get(id);
          if (!prev) { byInsp.set(id, it); }
          else {
            const score = (x)=> (x.origin === 'inspections' ? 2 : 1);
            if (score(it) >= score(prev)) byInsp.set(id, it);
          }
        });
        const arr = Array.from(byInsp.values()).sort(function(a,b){
          var bs = (b.createdAt && b.createdAt.seconds) ? b.createdAt.seconds : 0;
          var as = (a.createdAt && a.createdAt.seconds) ? a.createdAt.seconds : 0;
          return bs - as;
        });
        onItems(arr);
      };
      // Seed initial data to avoid empty UI if realtime is bloqueado por reglas
      try {
        const initial = await loadData();
        initial.forEach(function(it, idx){ const key = (it.origin === 'inspections') ? ('root/'+it.id) : ('sub/'+(it.itemKey||'')+'/'+it.id+'/'+idx); map.set(key, it); });
        apply();
      } catch {}
      try {
        const qRoot = query(collection(db, 'inspections'), orderBy('createdAt', 'desc'));
        onSnapshot(qRoot, (snap) => {
          snap.docChanges().forEach(ch => {
            const d = ch.doc; const data = d.data(); const key = 'root/'+d.id;
            if (ch.type === 'removed') { map.delete(key); }
            else { map.set(key, Object.assign({ id: d.id, origin: 'inspections', path: 'inspections/'+d.id }, data)); }
          });
          apply();
        }, (err) => { try { console.warn('[realtime] root inspections off', err?.message||err); } catch {} });
      } catch {}
      try {
        const qSub = query(collectionGroup(db, 'inspections'), orderBy('createdAt', 'desc'));
        onSnapshot(qSub, (snap) => {
          snap.docChanges().forEach(ch => {
            const d = ch.doc; const data = d.data(); var ik=null; try{ ik = d.ref.parent.parent.id; }catch{} const key = d.ref.path;
            if (ch.type === 'removed') { map.delete(key); }
            else { map.set(key, Object.assign({ id: d.id, origin: 'items/*/inspections', itemKey: ik, path: d.ref.path }, data)); }
          });
          apply();
        }, (err) => { try { console.warn('[realtime] sub inspections off', err?.message||err); } catch {} });
      } catch {}
    }

    bindAuth();

    async function loadInventoryMap(){
      try {
        const res = await fetch('invsistejm.csv', { cache: 'no-cache' });
        if (!res.ok) return {};
        const text = await res.text();
        // Parse CSV (simple, soporta comillas dobles)
        function detectDelimiter(sample){
          const line = (sample.replace(/\r\n?/g,'\n').split('\n').find(l=>l.trim().length>0)) || '';
          const cands = [',',';','\t','|'];
          let best = { d: ',', n: 0 };
          for (const d of cands){ const n = (line.split(d).length - 1); if (n > best.n) best = { d, n }; }
          return best.d === '\t' ? '\t' : best.d;
        }
        const delim = detectDelimiter(text);
        const lines = text.replace(/\r\n?/g,'\n').split('\n').filter(l=>l.length>0);
        const rows = [];
        for (const line of lines){
          const out = []; let cur=''; let inQ=false;
          for (let i=0;i<line.length;i++){
            const ch = line[i];
            if (ch==='"'){
              if (inQ && line[i+1]==='"'){ cur+='"'; i++; }
              else { inQ = !inQ; }
            } else if (!inQ && ch === (delim==='\t' ? '\t' : delim)){
              out.push(cur); cur='';
            } else { cur+=ch; }
          }
          out.push(cur); rows.push(out);
        }
        const headers = (rows.shift()||[]).map(h=>String(h||'').trim());
        // Buscar índices
        const idxEquipo = headers.findIndex(h => /EQUIPO\s*\/\s*ACTIVO/i.test(h));
        const idxSerial = headers.findIndex(h => /^SERIAL$/i.test(h));
        let idxProducto = headers.findIndex(h => /^Producto$/i.test(h));
        if (idxProducto < 0) {
          // tomar el primer 'TIPO' como Producto, o la columna 4 si existe
          idxProducto = headers.findIndex(h => /^TIPO$/i.test(h));
          if (idxProducto < 0 && headers.length > 4) idxProducto = 4;
        }
        if (idxProducto < 0) return {};
        const byEquipo = {};
        const bySerial = {};
        for (const r of rows){
          const keyEquipo = idxEquipo >= 0 ? String(r[idxEquipo]||'').trim() : '';
          const keySerial = idxSerial >= 0 ? String(r[idxSerial]||'').trim() : '';
          const prod = String(r[idxProducto]||'').trim();
          if (keyEquipo) byEquipo[keyEquipo] = prod;
          if (keySerial) bySerial[keySerial] = prod;
        }
        return { byEquipo, bySerial };
      } catch { return {}; }
    }
    function resolveProductoFromInventory(meta, it){
      try {
        const inv = window.invProductoMap || {};
        const byEquipo = inv.byEquipo || {};
        const bySerial = inv.bySerial || {};
        const m = meta || {};
        const equipoKeys = [m.activo, m.equipo, m.asset, m.itemKey, it && it.itemKey, m['EQUIPO / ACTIVO'], m.equipo_activo, m.equipoActivoId, m.codigo, m.nomenclatura];
        for (let k of equipoKeys){ if (k){ const v = byEquipo[String(k).trim()]; if (v) return v; } }
        const serialKeys = [m.serial, m.SERIAL, m.serie, m.Serie];
        for (let k of serialKeys){ if (k){ const v = bySerial[String(k).trim()]; if (v) return v; } }
      } catch {}
      return '';
    }
    async function start() {
      window.invProductoMap = await loadInventoryMap();
      // Render once with current data
      let first = await loadData();
      // Include last locally saved inspection if Firestore read misses it
      try {
        const raw = localStorage.getItem('pct_lastSavedInspectionTemp');
        if (raw) {
          const temp = JSON.parse(raw);
          if (temp && temp.meta) {
            const exists = first.some(x => (x.meta && x.meta.inspectionId) && (x.meta.inspectionId === temp.meta.inspectionId));
            if (!exists) first = [temp, ...first];
          }
        }
      } catch {}
      if (window.populateProductSelect) window.populateProductSelect(first);
      bindFilters(first);
      renderRows(first);
      // Then subscribe for updates (may be limitado por reglas)
      subscribeData((data) => {
        if (window.populateProductSelect) window.populateProductSelect(data);
        bindFilters(data);
        renderRows(data);
      });
    }
    if (window.currentUser) {
      start();
    } else {
      const tbody = document.getElementById('rows');
      if (tbody) tbody.innerHTML = '<tr><td colspan="9" class="muted">Inicia sesión para ver inspecciones…</td></tr>';
      window.addEventListener('auth:changed', (e) => {
        if (e && e.detail && e.detail.user) start();
        else if (tbody) tbody.innerHTML = '<tr><td colspan="9" class="muted">Inicia sesión para ver inspecciones…</td></tr>';
      });
    }

    // If a deep-link is present, open read-only view automatically
    (function(){
      try {
        const params = new URLSearchParams(location.search);
        const p = params.get('view');
        if (p) openViewByPath(decodeURIComponent(p));
      } catch {}
    })();

    // Export helpers (CSV)
    function csvEscape(v){ var s = String(v == null ? '' : v); return /[",\n]/.test(s) ? '"'+s.replace(/"/g,'""')+'"' : s; }
    function getEquipoActivo(meta, it){
      try {
        const m = meta || {}; if (m.equipoActivo) return String(m.equipoActivo);
        if (m.itemKey) return String(m.itemKey);
        if (it && it.itemKey) return String(it.itemKey);
        const inv = m.inv; if (inv && Array.isArray(inv.headers) && Array.isArray(inv.row)){
          const headers = inv.headers.map(h=>String(h||'').trim());
          const idxEquipo = headers.findIndex(h=>/EQUIPO\s*\/\s*ACTIVO/i.test(h));
          if (idxEquipo >= 0) return String(inv.row[idxEquipo]||'').trim();
        }
      } catch {}
      return '';
    }
    function buildRowArray(it){
      const m = it.meta || {}; const u = m.user || {}; const g = m.geo || {}; const fecha = m.createdAtLocal ? fmtDate(m.createdAtLocal) : fmtDate(it.createdAt||'');
      const equipo = getEquipoActivo(m, it);
      var prod = window.getProductFromMeta ? window.getProductFromMeta(m) : ((m.producto||m.product||m.tipo1||'')==='—'?'':(m.producto||m.product||m.tipo1||''));
      if (!prod) { prod = resolveProductoFromInventory(m, it); }
      var dispId = (window.fmtIdFromDate ? window.fmtIdFromDate(m.createdAtLocal || it.createdAt || '') : '') || (m.inspectionId || it.id);
      return [fecha, equipo, prod, getEvaluation(m)||'', (g.lat&&g.lng)? (String(g.lat)+','+String(g.lng)) : '', u.displayName||u.email||'', dispId, it.origin||''];
    }
    function exportItemCSV(it){
      const headers = ['Fecha','Equipo/Activo','Producto','Evaluación','Ubicación','Usuario','Inspección','Origen'];
      const arr = [headers, buildRowArray(it)];
      const blob = new Blob([arr.map(function(r){return r.map(csvEscape).join(',');}).join('\n')], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      var iid = (it.meta && it.meta.inspectionId) || it.id;
      const a = document.createElement('a'); a.href=url; a.download = 'inspeccion-' + iid + '.csv'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    }
    function exportAllCSV(items){
      const headers = ['Fecha','Equipo/Activo','Producto','Evaluación','Ubicación','Usuario','Inspección','Origen'];
      const lines = [headers.map(csvEscape).join(',')];
      for (var i=0;i<items.length;i++){ var it2=items[i]; lines.push(buildRowArray(it2).map(csvEscape).join(',')); }
      const blob = new Blob([lines.join('\n')], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download = 'registro-inspecciones.csv'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    }
    function buildPrintableHTML(rows){
      // Construye HTML completo usando DOM para evitar tokens inesperados
      const doc = document.implementation.createHTMLDocument('Inspecciones');
      const meta = doc.createElement('meta'); meta.setAttribute('charset','utf-8'); doc.head.appendChild(meta);
      const style = doc.createElement('style');
      style.textContent = `
        body{font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;padding:16px;position:relative}
        table{width:100%;border-collapse:collapse;}
        th,td{border:1px solid #ccc;padding:6px 8px;text-align:left;}
        thead th{background:#f6f7f9;}
        h1{font-size:18px;margin:0 0 12px;}
        @media print{
          body::before{
            content:"";
            position:fixed; inset:0; pointer-events:none;
            background:url('img/logopctch.png') center center / 50% no-repeat;
            opacity:0.08; z-index:-1;
          }
        }
      `;
      doc.head.appendChild(style);
      const h1 = doc.createElement('h1'); h1.textContent = 'Inspecciones'; doc.body.appendChild(h1);
      const table = doc.createElement('table');
      const thead = doc.createElement('thead'); const trh = doc.createElement('tr');
      ['Fecha','Equipo/Activo','Producto','Evaluación','Ubicación','Usuario','Inspección','Origen'].forEach(t=>{ const th=doc.createElement('th'); th.textContent=t; trh.appendChild(th); });
      thead.appendChild(trh); table.appendChild(thead);
      const tbody = doc.createElement('tbody');
      for (const r of rows){
        const tr = doc.createElement('tr');
        for (const c of r){ const td = doc.createElement('td'); td.textContent = String(c==null?'':c); tr.appendChild(td); }
        tbody.appendChild(tr);
      }
      table.appendChild(tbody); doc.body.appendChild(table);
      return '<!doctype html>\n' + doc.documentElement.outerHTML;
    }
    function exportItemPDF(it){
      try {
        const w = window.open('', '_blank'); if (!w) return;
        const html = buildDetailHTML(it);
        w.document.open(); w.document.write(html); w.document.close();
        const onReady = () => { try { w.focus(); w.print(); } catch {} };
        // Wait for logo image to load before printing
        try { const img = w.document.querySelector('img.logo'); if (img && !img.complete) { img.onload = onReady; return; } } catch {}
        setTimeout(onReady, 300);
      } catch {}
    }
    function exportAllPDF(items){
      const rows = items.map(it => buildRowArray(it));
      const w = window.open('', '_blank'); if (!w) return;
      const html = buildPrintableHTML(rows);
      w.document.open(); w.document.write(html); w.document.close();
      setTimeout(() => { try { w.focus(); w.print(); } catch {} }, 300);
    }
    // Build a detailed HTML similar to primaria.html (read-only)
    function buildDetailHTML(it){
      const meta = it.meta || {};
      const user = meta.user || {};
      const geo = meta.geo || {};
      function safe(v){ return String(v == null ? '' : v); }
      function fmt(d){ try{ if (d && d.toDate) return d.toDate().toLocaleString(); if (typeof d==='string') return new Date(d).toLocaleString(); if (d instanceof Date) return d.toLocaleString(); return ''; } catch { return ''; } }
      function evalText(m){
        try {
          let v = (m && (m.evaluation || m.eval || m.status || m.resultado)) || '';
          v = String(v).trim().toLowerCase();
          if (!v) return '';
          if (['operativo','ok','accept','accepted','aceptado','aceptada','aprobado','aprobada'].includes(v)) return 'Operativo';
          if (['no operativo','no_operativo','rechazado','rechazada','fail','rejected','no aceptado','no_aplica_malo'].includes(v)) return 'No operativo';
          return v;
        } catch { return ''; }
      }
      const created = fmt(it.createdAt || meta.createdAtLocal || '');
      const equipo = safe(meta.equipoActivo || it.itemKey || '');
      const producto = (window.getProductFromMeta ? window.getProductFromMeta(meta) : (meta.producto||meta.product||meta.tipo1||'')) || '';
      const hasGeo = !!(geo.lat && geo.lng);
      const ubic = hasGeo ? (String(geo.lat)+', '+String(geo.lng)) : '';
      const tipo = safe(meta.tipoInspeccion || meta.tipo1 || '');
      const quien = safe(user.displayName || user.email || user.uid || '');
      const origen = safe(it.origin || '');
      const evalv = evalText(meta);
      const inspeccionId = safe(meta.inspectionId || it.id || '');
      // normalize rows
      const headers = Array.isArray(it.headers) ? it.headers : (Array.isArray(meta.headers) ? meta.headers : []);
      const rows = Array.isArray(it.rows) ? it.rows : [];
      // If rows are objects with parametro + values, derive columns
      let colKeys = [];
      if (rows.length){
        const sample = rows[0];
        if (sample && typeof sample === 'object') {
          colKeys = Object.keys(sample).filter(k => k !== 'id');
        }
      }
      function renderRows(){
        if (!rows.length) return '<tr><td colspan="2">(Sin filas)</td></tr>';
        // Prefer parametro + valor columns if present
        if (rows[0] && (rows[0].parametro != null || rows[0].Parametro != null)){
          const getP = r => r.parametro ?? r.Parametro ?? '';
          const getV = r => {
            const keys = Object.keys(r).filter(k => k !== 'parametro' && k !== 'Parametro');
            const vals = keys.map(k => r[k]).filter(v => v != null && v !== '').slice(0,3);
            return vals.join(' / ');
          };
          return rows.map((r,i)=>`<tr><td class="num">${i+1}</td><td class="param">${safe(getP(r))}</td><td>${safe(getV(r))}</td></tr>`).join('');
        }
        // Generic object rows
        const hdr = colKeys.map(h=>`<th>${safe(h)}</th>`).join('');
        const body = rows.map(r=>`<tr>${colKeys.map(h=>`<td>${safe(r[h])}</td>`).join('')}</tr>`).join('');
        return `<tr>${hdr}</tr>` + body;
      }
      const doc = document.implementation.createHTMLDocument('Inspección');
      const metaTag = doc.createElement('meta'); metaTag.setAttribute('charset','utf-8'); doc.head.appendChild(metaTag);
      const style = doc.createElement('style'); 
      style.textContent = `
        :root{--border:#e4e8ee;--muted:#64748b}
        @page { size: A4 portrait; margin: 16mm 12mm; }
        body{font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;padding:0 0 12px 0;color:#0f172a;background:#ffffff; -webkit-print-color-adjust: exact; print-color-adjust: exact;}
        h1{margin:0 0 12px;font-size:20px;letter-spacing:.2px}
        .card{max-width:920px;margin:0 auto;padding:18px 18px 20px;background:#fff;border:1px solid var(--border);border-radius:12px;box-shadow:0 10px 30px rgba(15,23,42,0.08);position:relative}
        .card::before{content:"";position:absolute;top:-1px;left:16px;right:16px;height:3px;background:linear-gradient(90deg,#1aa885 0%, #0bb3d9 50%, transparent 100%);filter:drop-shadow(0 0 4px rgba(11,179,217,0.35))}
        .header{display:flex;align-items:center;justify-content:center;margin-bottom:10px}
        .logo{height:52px}
        .meta{display:grid;grid-template-columns:1fr 1fr;gap:8px 16px;margin-bottom:12px}
        .label{color:var(--muted);font-size:.9rem}
        .value{font-weight:600}
        .table-wrap{overflow:hidden;border:1px solid var(--border);border-radius:12px;background:#fff}
        table{width:100%;border-collapse:collapse;min-width:720px}
        th,td{padding:9px 10px;border-bottom:1px solid rgba(15,23,42,0.08);text-align:left;font-size:14px}
        thead th{background:#f6f8fb;position:sticky;top:0;z-index:1}
        .num{width:48px;color:var(--muted)}
        .param{font-weight:600;color:#0f172a}
        .pill{display:inline-block;padding:4px 8px;border-radius:999px;border:1px solid rgba(2,132,199,0.25);font-weight:600;color:#334155;background:#fff}
        .pill.ok{border-color:rgba(16,185,129,.35);color:#065f46;background:rgba(16,185,129,.1)}
        .pill.bad{border-color:rgba(239,68,68,.35);color:#7f1d1d;background:rgba(239,68,68,.1)}
        @media print{
          body{background:#fff}
          .card{box-shadow:none;border-color:#dfe4ea}
          thead th{position:static}
          tr{page-break-inside:avoid}
        }
      `; 
      doc.head.appendChild(style);
      const card = doc.createElement('div'); card.className='card'; doc.body.appendChild(card);
      const header = doc.createElement('div'); header.className='header';
      const logo = doc.createElement('img'); logo.src='img/logopct.png'; logo.alt='PCT'; logo.className='logo';
      header.appendChild(logo); card.appendChild(header);
      const h1 = doc.createElement('h1'); h1.textContent = 'Inspección — Testimonio'; card.appendChild(h1);
      const metaGrid = doc.createElement('div'); metaGrid.className='meta';
      function row(label,valHTML){ const d1=doc.createElement('div'); const l=doc.createElement('div'); l.className='label'; l.textContent=label; const v=doc.createElement('div'); v.className='value'; v.innerHTML = (valHTML && String(valHTML).trim()) ? String(valHTML) : '—'; d1.appendChild(l); d1.appendChild(v); metaGrid.appendChild(d1);} 
      row('Usuario', quien);
      row('Cliente', 'Interno');
      row('Lugar', 'Base de Operaciones PCT');
      row('Fecha / Hora (realización)', created);
      row('Tipo de Inspección', tipo);
      const evalHtml = evalv ? `<span class="pill ${evalv==='Aceptado'?'ok':'bad'}">${evalv}</span>` : '—';
      row('Evaluación', evalHtml);
      row('Equipo/Activo', equipo);
      row('Producto', producto);
      const ubicHtml = hasGeo ? `<a href="https://maps.google.com/?q=${encodeURIComponent(ubic)}" target="_blank" rel="noopener">${ubic}</a>` : '—';
      row('Ubicación', ubicHtml);
      row('Origen', origen);
      row('Inspección ID', inspeccionId);
      card.appendChild(metaGrid);
      const wrap = doc.createElement('div'); wrap.className='table-wrap';
      const table = doc.createElement('table');
      const thead = doc.createElement('thead'); thead.innerHTML = '<tr><th class="num">#</th><th>Parámetro</th><th>Valor</th></tr>'; table.appendChild(thead);
      const tbody = doc.createElement('tbody'); tbody.innerHTML = renderRows(); table.appendChild(tbody);
      wrap.appendChild(table); card.appendChild(wrap);
      const foot = doc.createElement('div'); foot.style.cssText='margin-top:10px;color:#64748b;font-size:.9rem;text-align:right';
      foot.textContent = 'Generado automáticamente';
      card.appendChild(foot);
      // No acciones inline: exportación se hace desde inslis
      return '<!doctype html>\n' + doc.documentElement.outerHTML;
    }

    // Read-only view: open a detailed window (testimonio)
    function viewItem(it){
      try {
        const w = window.open('', '_blank'); if (!w) return;
        const html = buildDetailHTML(it);
        w.document.open(); w.document.write(html); w.document.close();
      } catch {}
    }

    // Deep-link support: inslis.html?view=<path>
    async function openViewByPath(path){
      try {
        await ready();
        const db = window.db;
        // path can be 'inspections/<id>' or 'items/<itemId>/inspections/<id>'
        const ref = doc(db, ...path.split('/'));
        const snap = await getDoc(ref);
        if (!snap.exists()) return;
        const data = snap.data() || {};
        // enrich for renderer compatibility
        const it = { id: snap.id, path: snap.ref.path, origin: path.startsWith('inspections/') ? 'inspections' : 'items/*/inspections', ...data };
        viewItem(it);
      } catch {}
    }
    function escapeHtml(s){ s = String(s==null?'':s); return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\"/g,'&quot;').replace(/'/g,'&#39;'); }
  </script>
  <script type="module" src="firebase-init.js?v=3"></script>
  <script src="script.js?v=3"></script>
  <div id="lockOverlay" class="lock-overlay">
    <div class="lock-card">
      <h2>Inicia sesión para continuar</h2>
      <p class="sub">Autentícate para ver inspecciones.</p>
      <div class="field"><input id="authEmail" type="email" placeholder="correo@dominio.com" autocomplete="username"></div>
      <div class="field"><input id="authPassword" type="password" placeholder="Contraseña" autocomplete="current-password"></div>
      <div class="auth-actions">
        <button id="overlayLoginEmailBtn" type="button" class="btn">Entrar</button>
        <button id="overlayResetBtn" type="button" class="btn">Restablecer</button>
      </div>
    </div>
  </div>
  <footer> <a href="https://unknownshoppers.com" target="_blank" rel="noopener noreferrer">Powered by <img src="img/logotus.jpg" alt="Unknown Shoppers" style="height:18px; vertical-align:middle"></a></footer>
</body>
</html>
