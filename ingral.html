<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Inventario General (CSV)</title>
  <link rel="stylesheet" href="styles.css" />
  <style>
    main { position: relative; max-width: 1600px; margin: 0 auto; padding-left: 12px; padding-right: 12px; }
    @media (min-width: 1800px) { main { max-width: 1800px; } }
    /* Auth gate */
    body.locked main { filter: blur(4px); pointer-events: none; user-select: none; }
    .lock-overlay { position: fixed; inset: 0; display: none; align-items: center; justify-content: center; padding: 24px; background: rgba(15,23,42,0.35); backdrop-filter: blur(2px); z-index: 50; }
    body.locked .lock-overlay { display: flex; }
    .lock-card { width: 100%; max-width: 520px; background: #fff; border: 1px solid var(--steel-400); border-radius: 14px; padding: 22px; box-shadow: var(--shadow); text-align: center; }
    .field { display: flex; gap: 8px; align-items: center; margin: 8px 0; }
    .field input { flex: 1; height: 40px; border: 1px solid var(--steel-400); border-radius: 10px; padding: 8px 10px; font: inherit; }
    .auth-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
    /* Navbar */
    .topbar { position: sticky; top: 0; display: flex; align-items: center; gap: 12px; padding: 10px 14px; background:#fff; border-bottom:1px solid var(--steel-300); z-index: 40; }
    .brand { font-weight: 800; color: var(--accent); text-decoration: none; }
    .nav-toggle { margin-left: auto; display: none; background: transparent; border: 1px solid var(--steel-400); padding: 6px 10px; border-radius: 8px; }
    .nav-links { list-style: none; display: flex; gap: 12px; margin: 0; padding: 0; }
    .nav-links a { text-decoration: none; color: var(--text-200); font-weight: 600; padding: 6px 8px; border-radius: 8px; }
    .nav-links a[aria-current="page"] { background: rgba(11,179,217,0.08); color: var(--accent); }
    .user-badge { position: relative; right: 0; top: 0; margin-left: auto; display:none; align-items: center; gap: 8px; padding: 6px 10px; border: 1px solid rgba(2,132,199,0.25); border-radius: 999px; background: #fff; color: var(--text-200); font-weight: 600; }
    .user-avatar { width: 20px; height: 20px; border-radius: 50%; background: linear-gradient(135deg, var(--accent-2), var(--accent)); }
    .user-menu { position: absolute; right: 0; top: calc(100% + 6px); display: none; min-width: 180px; background:#fff; border:1px solid var(--steel-400); border-radius: 10px; box-shadow: var(--shadow); padding: 6px; }
    .user-menu a, .user-menu button { width: 100%; display: block; text-align: left; padding: 8px 10px; border: none; background: none; color: var(--text-200); text-decoration: none; border-radius: 8px; cursor: pointer; }
    .user-menu a:hover, .user-menu button:hover { background: rgba(2,132,199,0.08); }
    .user-badge.open .user-menu { display: block; }
    @media (max-width: 760px) { .nav-toggle { display: inline-block; } .nav-links { position: absolute; left:0; right:0; top:54px; background:#fff; border-bottom:1px solid var(--steel-300); display:none; flex-direction:column; padding:8px; } .nav-links.open { display:flex; } }
    /* Desktop-only notice */
    .desktop-only { display:none; padding: 18px; margin: 12px; border:1px solid var(--steel-400); border-radius: 12px; background:#fff; box-shadow: var(--shadow); }
    @media (max-width: 1024px) { .desktop-only { display:block; } main { display:none; } }
    .filters { display: grid; grid-template-columns: repeat(3, minmax(0, 1fr)); gap: 10px; margin: 10px 0 16px; }
    .filters input, .filters select { height: 38px; border: 1px solid var(--steel-400); border-radius: 10px; padding: 6px 10px; font: inherit; }
    .table-wrap { overflow-x: auto; overflow-y: hidden; border: 1px solid var(--steel-400); border-radius: 10px; background: #fff; -webkit-overflow-scrolling: touch; }
    .table-wrap::-webkit-scrollbar { height: 10px; }
    .table-wrap::-webkit-scrollbar-thumb { background: rgba(2,132,199,0.35); border-radius: 8px; }
    table.grid { width: max-content; border-collapse: collapse; table-layout: auto; }
    table.grid th, table.grid td { padding: 8px 10px; border-bottom: 1px solid rgba(15,23,42,0.08); text-align: left; white-space: nowrap; }
    table.grid thead th { position: sticky; top: 0; background: var(--bg-800); z-index: 1; }
    /* Tooltip */
    .tip { position: fixed; z-index: 60; pointer-events: none; background: #0f172a; color:#fff; font-size:12px; padding:6px 8px; border-radius: 8px; box-shadow: 0 6px 16px rgba(2,132,199,0.18); max-width: 320px; }
    .btn { appearance: none; border: 1px solid var(--steel-400); background: #fff; color: var(--text-100); padding: 8px 12px; border-radius: 10px; font-weight: 600; cursor: pointer; }
    .btn:hover { border-color: rgba(2,132,199,0.35); box-shadow: 0 6px 16px rgba(2,132,199,0.08); }
    .muted { color: var(--muted); }
    @media (max-width: 768px) { .filters { grid-template-columns: 1fr; } }
  </style>
</head>
<body>
  <nav class="topbar" aria-label="Principal">
    <a class="brand" href="primaria.html">PCT</a>
    <button id="navToggle" class="nav-toggle" aria-expanded="false" aria-controls="navMenu" aria-label="Abrir menú">☰</button>
    <ul id="navMenu" class="nav-links">
      <li><a href="primaria.html">Primaria</a></li>
      <li><a href="inslis.html">Lista de inspecciones</a></li>
      <li><a href="intop.html">Aproximaciones</a></li>
      <li><a href="ingral.html" aria-current="page">Inventario</a></li>
      <li><a href="opciones.html">Opciones</a></li>
    </ul>
    <div id="userBadge" class="user-badge">
      <div class="user-avatar"></div>
      <span id="userName">Usuario</span>
      <div class="user-menu" id="userMenu" role="menu" aria-hidden="true">
        <a href="opciones.html" role="menuitem">Opciones</a>
        <button id="logoutMenuItem" type="button" role="menuitem">Cerrar sesión</button>
      </div>
    </div>
  </nav>
  <div class="desktop-only">Esta vista es exclusiva para escritorio debido al ancho de tabla. Usa una pantalla más grande para ver el Inventario.</div>
  <main>
    <h1>Inventario General</h1>
    <p class="accent-left">Fuente: invsistejm.csv. Esta vista muestra el inventario completo con búsqueda y filtros básicos.</p>

    <div class="filters">
      <input id="q" type="search" placeholder="Buscar en todo el inventario" />
      <select id="colFilter"><option value="">Filtrar por columna…</option></select>
      <input id="colValue" type="search" placeholder="Valor de columna (opcional)" />
    </div>

    <div class="table-wrap">
      <table class="grid" id="tbl">
        <thead><tr id="thead"></tr></thead>
        <tbody id="tbody"><tr><td class="muted">Cargando CSV…</td></tr></tbody>
      </table>
    </div>
  </main>

  <script src="firebase-config.js"></script>
  <script>
    window.firebaseConfig = window.firebaseConfig || {
      apiKey: "AIzaSyCaG3KkC5q0VhNDfelH3OTTC0Qrpf7PRs4",
      authDomain: "pct-checklist.firebaseapp.com",
      projectId: "pct-checklist",
      storageBucket: "pct-checklist.firebasestorage.app",
      messagingSenderId: "573177765621",
      appId: "1:573177765621:web:7f7d58915121440cebefbc"
    };
  </script>
  <script type="module" src="firebase-init.js?v=2"></script>
  <script src="script.js?v=2"></script>
  <script>
    async function loadCSV(path){
      const res = await fetch(path, { cache: 'no-cache' });
      if (!res.ok) throw new Error('No se pudo cargar CSV');
      const text = await res.text();
      return parseCSV(text);
    }
    function detectDelimiter(sample){
      const line = (sample.replace(/\r\n?/g,'\n').split('\n').find(l=>l.trim().length>0)) || '';
      const cands = [',',';','\t','|'];
      let best = { d: ',', n: 0 };
      for (const d of cands){
        const n = (line.split(d).length - 1);
        if (n > best.n) best = { d, n };
      }
      return best.d === '\t' ? '\t' : best.d;
    }
    function parseCSV(text){
      const delim = detectDelimiter(text);
      const lines = text.replace(/\r\n?/g, '\n').split('\n').filter(l => l.length > 0);
      const rows = [];
      for (const line of lines){
        const out = []; let cur=''; let inQ=false;
        for (let i=0;i<line.length;i++){
          const ch = line[i];
          if (ch==='"'){
            if (inQ && line[i+1]==='"'){ cur+='"'; i++; }
            else { inQ = !inQ; }
          } else if (!inQ && ch === (delim==='\t' ? '\t' : delim)){
            out.push(cur);
            cur='';
          } else {
            cur+=ch;
          }
        }
        out.push(cur);
        rows.push(out);
      }
      const headers = rows.shift() || [];
      return { headers, rows };
    }

    const state = { headers: [], rows: [], view: [] };

    function renderHeader(){
      const thead = document.getElementById('thead');
      thead.innerHTML='';
      state.headers.forEach(h=>{
        const th = document.createElement('th'); th.textContent=h; thead.appendChild(th);
      });
      // fill column filter
      const sel = document.getElementById('colFilter');
      sel.innerHTML = '<option value="">Filtrar por columna…</option>' + state.headers.map(h=>`<option>${h}</option>`).join('');
    }
    function renderBody(){
      const tbody = document.getElementById('tbody');
      const frag = document.createDocumentFragment();
      if (!state.view.length){ tbody.innerHTML='<tr><td class="muted">Sin datos</td></tr>'; return; }
      tbody.innerHTML='';
      state.view.forEach((r, rIdx)=>{
        const tr = document.createElement('tr');
        tr.dataset.rowIndex = String(rIdx);
        r.forEach((cell, cIdx)=>{
          const td = document.createElement('td');
          td.textContent = cell;
          td.dataset.colIndex = String(cIdx);
          tr.appendChild(td);
        });
        frag.appendChild(tr);
      });
      tbody.appendChild(frag);
      bindTooltips();
    }
    function applyFilters(){
      const q = (document.getElementById('q').value || '').toLowerCase();
      const col = document.getElementById('colFilter').value || '';
      const colVal = (document.getElementById('colValue').value || '').toLowerCase();
      const colIdx = col ? state.headers.indexOf(col) : -1;
      state.view = state.rows.filter(r=>{
        const text = r.join(' ').toLowerCase();
        if (q && !text.includes(q)) return false;
        if (colIdx>=0 && colVal && String(r[colIdx]||'').toLowerCase().indexOf(colVal)===-1) return false;
        return true;
      });
      renderBody();
    }

    // Init
    (async () => {
      try {
        const { headers, rows } = await loadCSV('invsistejm.csv');
        state.headers = headers; state.rows = rows; state.view = rows.slice();
        renderHeader(); renderBody();
        ['q','colFilter','colValue'].forEach(id=>{
          const el = document.getElementById(id);
          el && ['input','change'].forEach(ev=> el.addEventListener(ev, applyFilters));
        });
        // Enhance horizontal scroll (wheel and drag)
        const wrap = document.querySelector('.table-wrap');
        if (wrap) {
          wrap.addEventListener('wheel', (e) => {
            const dx = Math.abs(e.deltaX), dy = Math.abs(e.deltaY);
            if (dy > dx) { wrap.scrollLeft += e.deltaY; e.preventDefault(); }
          }, { passive: false });
          let isDown = false, startX = 0, startLeft = 0;
          wrap.addEventListener('mousedown', (e) => { isDown = true; startX = e.pageX; startLeft = wrap.scrollLeft; wrap.style.cursor='grabbing'; });
          wrap.addEventListener('mouseleave', () => { isDown = false; wrap.style.cursor=''; });
          wrap.addEventListener('mouseup', () => { isDown = false; wrap.style.cursor=''; });
          wrap.addEventListener('mousemove', (e) => { if (!isDown) return; const dx = e.pageX - startX; wrap.scrollLeft = startLeft - dx; });
        }
      } catch (e){
        document.getElementById('tbody').innerHTML = `<tr><td class="muted">${e.message}</td></tr>`;
      }
    })();
    function bindTooltips(){
      let tip = document.querySelector('.tip');
      if (!tip) { tip = document.createElement('div'); tip.className='tip'; tip.style.display='none'; document.body.appendChild(tip); }
      const tbody = document.getElementById('tbody');
      if (!tbody) return;
      tbody.addEventListener('mousemove', (e)=>{
        const td = e.target.closest('td');
        if (!td) { tip.style.display='none'; return; }
        const tr = td.parentElement;
        const cIdx = Number(td.dataset.colIndex||-1);
        const rIdx = Number(tr?.dataset?.rowIndex||-1);
        if (cIdx<0 || rIdx<0) { tip.style.display='none'; return; }
        const header = state.headers[cIdx] || '';
        const value = td.textContent || '';
        tip.innerHTML = `<strong>${header}</strong><br>${value}<br><span class="muted">Fila ${rIdx+1}</span>`;
        tip.style.left = Math.min(e.clientX + 16, window.innerWidth - 220) + 'px';
        tip.style.top = Math.min(e.clientY + 16, window.innerHeight - 60) + 'px';
        tip.style.display='block';
      });
      tbody.addEventListener('mouseleave', ()=>{
        const tipEl = document.querySelector('.tip'); if (tipEl) tipEl.style.display='none';
      });
    }
  </script>
  <div id="lockOverlay" class="lock-overlay">
    <div class="lock-card">
      <h2>Inicia sesión para continuar</h2>
      <p class="sub">Autentícate para acceder a Inventario.</p>
      <div class="field"><input id="authEmail" type="email" placeholder="correo@dominio.com" autocomplete="username"></div>
      <div class="field"><input id="authPassword" type="password" placeholder="Contraseña" autocomplete="current-password"></div>
      <div class="auth-actions">
        <button id="overlayLoginEmailBtn" type="button" class="btn">Entrar</button>
        <button id="overlayResetBtn" type="button" class="btn">Restablecer</button>
      </div>
    </div>
  </div>
  <footer> <a href="https://unknownshoppers.com" target="_blank" rel="noopener noreferrer">Powered by <img src="img/logotus.jpg" alt="Unknown Shoppers" style="height:18px; vertical-align:middle"></a></footer>
</body>
</html>
