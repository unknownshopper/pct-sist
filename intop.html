<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Topología / UTT — Vida Operativa</title>
  <link rel="stylesheet" href="styles.css" />
  <style>
    main { position: relative; }
    .topbar { display:flex; justify-content: space-between; align-items:center; gap: 12px; }
    .grid2 { display: grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap: 10px; }
    .controls { display: grid; grid-template-columns: repeat(4, minmax(0,1fr)); gap: 10px; margin: 10px 0 16px; }
    .controls select, .controls input { height: 38px; border: 1px solid var(--steel-400); border-radius: 10px; padding: 6px 10px; font: inherit; }
    .controls .full { grid-column: 1 / -1; }
    .table-wrap { overflow: auto; border: 1px solid var(--steel-400); border-radius: 10px; background: #fff; }
    table.grid { width: 100%; border-collapse: collapse; min-width: 960px; }
    table.grid th, table.grid td { padding: 8px 10px; border-bottom: 1px solid rgba(15,23,42,0.08); text-align: left; }
    table.grid thead th { position: sticky; top: 0; background: var(--bg-800); z-index: 1; }
    .pill { display: inline-block; padding: 4px 8px; border-radius: 999px; border: 1px solid rgba(2, 132, 199, 0.25); font-weight: 600; color: var(--text-300); background: #fff; }
    .pill.ok { border-color: rgba(16,185,129,.35); color: #065f46; background: rgba(16,185,129,.1); }
    .pill.bad { border-color: rgba(239,68,68,.35); color: #7f1d1d; background: rgba(239,68,68,.1); }
    .muted { color: var(--muted); }
    @media (max-width: 1024px) { .controls { grid-template-columns: repeat(2, minmax(0,1fr)); } }
    @media (max-width: 640px) { .controls { grid-template-columns: 1fr; } }
  </style>
</head>
<body>
  <main>
    <div class="topbar">
      <h1>Topología / UTT — Vida Operativa</h1>
      <div>
        <a class="btn" href="ingral.html">Ver Inventario</a>
      </div>
    </div>
    <p class="accent-left">Carga <code>invsistejm.csv</code>, mapea columnas y calcula si la tubería es utilizable o está fuera de rango, y su vida operativa restante.</p>

    <div class="controls" id="controls">
      <select id="colId"><option value="">ID / # Equipo</option></select>
      <select id="colTipo"><option value="">Tipo (p. ej., Tubería)</option></select>
      <select id="colUTT"><option value="">UTT (espesor medido)</option></select>
      <select id="colTmin"><option value="">Espesor mínimo permitido (Tmin)</option></select>
      <select id="colCR"><option value="">Corrosión (mm/año)</option></select>
      <select id="colFecha"><option value="">Fecha referencia (opcional)</option></select>
      <input id="fTipo" type="search" placeholder="Filtrar Tipo (ej. Tubería)" />
      <input id="crDefault" type="number" step="0.001" min="0" placeholder="CR por defecto (mm/año)" />
      <div class="full">
        <label style="display:block; font-weight:600; margin-bottom:6px">Modo de evaluación</label>
        <div class="grid2">
          <label><input type="radio" name="mode" value="tmin" checked /> UTT ≥ Tmin ⇒ Utilizable</label>
          <label><input type="radio" name="mode" value="margin" /> UTT ≥ Tmin + Margen</label>
          <label>Margen (mm): <input id="margen" type="number" step="0.01" min="0" value="0" style="height:32px; margin-left:6px; width:140px"></label>
          <label>Años vida = (UTT − Tmin) / CR</label>
        </div>
      </div>
    </div>

    <div class="table-wrap">
      <table class="grid" id="tbl">
        <thead>
          <tr>
            <th>ID</th>
            <th>Tipo</th>
            <th>UTT (mm)</th>
            <th>Tmin (mm)</th>
            <th>CR (mm/año)</th>
            <th>Estado</th>
            <th>Vida restante (años)</th>
          </tr>
        </thead>
        <tbody id="tbody"><tr><td class="muted" colspan="7">Cargando CSV…</td></tr></tbody>
      </table>
    </div>
  </main>

  <script>
    async function loadCSV(path){
      const res = await fetch(path, { cache: 'no-cache' });
      if (!res.ok) throw new Error('No se pudo cargar CSV');
      const text = await res.text();
      return parseCSV(text);
    }
    function parseCSV(text){
      const lines = text.replace(/\r\n?/g, '\n').split('\n').filter(l=>l.length>0);
      const rows = [];
      for (const line of lines){
        const out = []; let cur=''; let inQ=false;
        for (let i=0;i<line.length;i++){
          const ch = line[i];
          if (ch==='"'){
            if (inQ && line[i+1]==='"'){ cur+='"'; i++; }
            else { inQ = !inQ; }
          } else if (ch===',' && !inQ){ out.push(cur); cur=''; }
          else { cur+=ch; }
        }
        out.push(cur);
        rows.push(out);
      }
      const headers = rows.shift() || [];
      return { headers, rows };
    }

    const state = { headers: [], rows: [], map: {}, view: [] };

    function fillSelects(){
      const ids = ['colId','colTipo','colUTT','colTmin','colCR','colFecha'];
      ids.forEach(id=>{
        const sel = document.getElementById(id);
        sel.innerHTML = `<option value="">${sel.options[0].textContent}</option>` + state.headers.map(h=>`<option>${h}</option>`).join('');
      });
      // auto-heurística básica
      const hint = (name) => state.headers.find(h=> h.toLowerCase().includes(name));
      const setIf = (id, name) => { const h = hint(name); if (h) document.getElementById(id).value = h; };
      setIf('colId','equipo'); setIf('colId','#'); setIf('colTipo','tuber'); setIf('colUTT','utt'); setIf('colTmin','tmin'); setIf('colCR','cr');
    }

    function readNumber(v){ const n = Number(String(v).replace(',','.').trim()); return isFinite(n) ? n : null; }

    function computeRow(r){
      const get = (selId)=> { const h = document.getElementById(selId).value; const idx = state.headers.indexOf(h); return idx>=0 ? r[idx] : ''; };
      const id = get('colId');
      const tipo = get('colTipo');
      const utt = readNumber(get('colUTT'));
      const tmin = readNumber(get('colTmin'));
      let cr = readNumber(get('colCR'));
      if (cr==null || cr===0){ const d = readNumber(document.getElementById('crDefault').value); if (d!=null) cr = d; }

      const mode = (document.querySelector('input[name="mode"]:checked')||{}).value || 'tmin';
      const margen = readNumber(document.getElementById('margen').value) || 0;

      let estado = '';
      if (utt==null || tmin==null){ estado = ''; }
      else {
        const req = mode==='margin' ? (tmin + margen) : tmin;
        estado = (utt >= req) ? 'Utilizable' : 'Fuera de rango';
      }

      let vida = '';
      if (utt!=null && tmin!=null && cr!=null && cr>0){
        const years = (utt - tmin) / cr;
        vida = isFinite(years) ? Math.max(0, years).toFixed(2) : '';
      }
      return { id, tipo, utt, tmin, cr, estado, vida };
    }

    function applyFilters(rows){
      const fTipo = (document.getElementById('fTipo').value||'').toLowerCase();
      return rows.filter(x => !fTipo || String(x.tipo||'').toLowerCase().includes(fTipo));
    }

    function render(){
      const tbody = document.getElementById('tbody');
      tbody.innerHTML='';
      let computed = state.rows.map(computeRow);
      computed = applyFilters(computed);
      if (!computed.length){ tbody.innerHTML = '<tr><td class="muted" colspan="7">Sin datos</td></tr>'; return; }
      const frag = document.createDocumentFragment();
      for (const x of computed){
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${x.id||''}</td>
          <td>${x.tipo||''}</td>
          <td>${x.utt!=null? Number(x.utt).toFixed(2): ''}</td>
          <td>${x.tmin!=null? Number(x.tmin).toFixed(2): ''}</td>
          <td>${x.cr!=null? Number(x.cr).toFixed(3): ''}</td>
          <td>${x.estado? `<span class="pill ${x.estado==='Utilizable'?'ok':'bad'}">${x.estado}</span>`: ''}</td>
          <td>${x.vida||''}</td>`;
        frag.appendChild(tr);
      }
      tbody.appendChild(frag);
    }

    function bind(){
      document.getElementById('controls').addEventListener('input', render);
      document.getElementById('controls').addEventListener('change', render);
    }

    (async () => {
      try {
        const { headers, rows } = await loadCSV('invsistejm.csv');
        state.headers = headers; state.rows = rows;
        fillSelects();
        bind();
        render();
      } catch (e){
        document.getElementById('tbody').innerHTML = `<tr><td class=\"muted\" colspan=\"7\">${e.message}</td></tr>`;
      }
    })();
  </script>
</body>
</html>
