<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Topología / UTT — Vida Operativa</title>
  <link rel="stylesheet" href="styles.css" />
  <style>
    main { position: relative; max-width: 1600px; margin: 0 auto; padding-left: 12px; padding-right: 12px; }
    @media (min-width: 1800px) { main { max-width: 1800px; } }
    /* Auth gate */
    body.locked main { filter: blur(4px); pointer-events: none; user-select: none; }
    .lock-overlay { position: fixed; inset: 0; display: none; align-items: center; justify-content: center; padding: 24px; background: rgba(15,23,42,0.35); backdrop-filter: blur(2px); z-index: 50; }
    body.locked .lock-overlay { display: flex; }
    .lock-card { width: 100%; max-width: 520px; background: #fff; border: 1px solid var(--steel-400); border-radius: 14px; padding: 22px; box-shadow: var(--shadow); text-align: center; }
    .field { display: flex; gap: 8px; align-items: center; margin: 8px 0; }
    .field input { flex: 1; height: 40px; border: 1px solid var(--steel-400); border-radius: 10px; padding: 8px 10px; font: inherit; }
    .auth-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
    /* Navbar */
    .topbar { position: sticky; top: 0; display: flex; align-items: center; gap: 12px; padding: 10px 14px; background:#fff; border-bottom:1px solid var(--steel-300); z-index: 40; }
    .brand { font-weight: 800; color: var(--accent); text-decoration: none; }
    .nav-toggle { margin-left: auto; display: none; background: transparent; border: 1px solid var(--steel-400); padding: 6px 10px; border-radius: 8px; }
    .nav-links { list-style: none; display: flex; gap: 12px; margin: 0; padding: 0; }
    .nav-links a { text-decoration: none; color: var(--text-200); font-weight: 600; padding: 6px 8px; border-radius: 8px; }
    .nav-links a[aria-current="page"] { background: rgba(11,179,217,0.08); color: var(--accent); }
    .user-badge { position: relative; right: 0; top: 0; margin-left: auto; display: none; align-items: center; gap: 8px; padding: 6px 10px; border: 1px solid rgba(2,132,199,0.25); border-radius: 999px; background: #fff; color: var(--text-300); font-weight: 600; }
    .user-avatar { width: 20px; height: 20px; border-radius: 50%; background: linear-gradient(135deg, var(--accent-2), var(--accent)); }
    .user-menu { position: absolute; right: 0; top: calc(100% + 6px); display: none; min-width: 180px; background:#fff; border:1px solid var(--steel-400); border-radius: 10px; box-shadow: var(--shadow); padding: 6px; }
    .user-menu a, .user-menu button { width: 100%; display: block; text-align: left; padding: 8px 10px; border: none; background: none; color: var(--text-200); text-decoration: none; border-radius: 8px; cursor: pointer; }
    .user-menu a:hover, .user-menu button:hover { background: rgba(2,132,199,0.08); }
    .user-badge.open .user-menu { display: block; }
    @media (max-width: 760px) { .nav-toggle { display: inline-block; } .nav-links { position: absolute; left:0; right:0; top:54px; background:#fff; border-bottom:1px solid var(--steel-300); display:none; flex-direction:column; padding:8px; } .nav-links.open { display:flex; } }
    .panel { border: 1px solid var(--steel-300); border-radius: 14px; box-shadow: var(--shadow); background: #fff; padding: 14px; }
    h1 { margin: 8px 6px 6px; }
    .help { color: var(--muted); margin: 0 6px 10px; font-size: .95rem; }
    .grid2 { display: grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap: 10px; }
    .controls { display: grid; grid-template-columns: repeat(6, minmax(0,1fr)); gap: 10px; margin: 8px 0 8px; }
    @media (max-width: 1200px){ .controls { grid-template-columns: repeat(3, minmax(0,1fr)); } }
    @media (max-width: 760px){ .controls { grid-template-columns: repeat(2, minmax(0,1fr)); } }
    .controls select, .controls input { height: 36px; border: 1px solid var(--steel-400); border-radius: 10px; padding: 6px 10px; font: inherit; }
    .controls .full { grid-column: 1 / -1; }
    .table-wrap { overflow-x: auto; overflow-y: hidden; border: 1px solid var(--steel-400); border-radius: 10px; background: #fff; -webkit-overflow-scrolling: touch; }
    .table-wrap::-webkit-scrollbar { height: 10px; }
    .table-wrap::-webkit-scrollbar-thumb { background: rgba(2,132,199,0.35); border-radius: 8px; }
    table.grid { width: max-content; border-collapse: collapse; table-layout: auto; }
    table.grid th, table.grid td { padding: 8px 10px; border-bottom: 1px solid rgba(15,23,42,0.08); text-align: left; white-space: nowrap; }
    table.grid thead th { position: sticky; top: 0; background: var(--bg-800); z-index: 1; }
    /* Tooltip */
    .tip { position: fixed; z-index: 60; pointer-events: none; background: #0f172a; color:#fff; font-size:12px; padding:6px 8px; border-radius: 8px; box-shadow: 0 6px 16px rgba(2,132,199,0.18); max-width: 320px; }
    .pill { display: inline-block; padding: 4px 8px; border-radius: 999px; border: 1px solid rgba(2, 132, 199, 0.25); font-weight: 600; color: var(--text-300); background: #fff; }
    .pill.ok { border-color: rgba(16,185,129,.35); color: #065f46; background: rgba(16,185,129,.1); }
    .pill.bad { border-color: rgba(239,68,68,.35); color: #7f1d1d; background: rgba(239,68,68,.1); }
    .muted { color: var(--muted); }
    @media (max-width: 1024px) { .controls { grid-template-columns: repeat(2, minmax(0,1fr)); } }
    @media (max-width: 640px) { .controls { grid-template-columns: 1fr; } }
  </style>
</head>
<body>
  <nav class="topbar" aria-label="Principal">
    <a class="brand" href="primaria.html">PCT</a>
    <button id="navToggle" class="nav-toggle" aria-expanded="false" aria-controls="navMenu" aria-label="Abrir menú">☰</button>
    <ul id="navMenu" class="nav-links">
      <li><a href="primaria.html">Primaria</a></li>
      <li><a href="inslis.html">Lista de inspecciones</a></li>
      <li><a href="intop.html" aria-current="page">Aproximaciones</a></li>
      <li><a href="ingral.html">Inventario</a></li>
    </ul>
    <button id="navLogin" class="btn" style="margin-left:auto; display:none">Iniciar sesión</button>
    <div id="userBadge" class="user-badge" style="display:none">
      <div class="user-avatar"></div>
      <span id="userName">Usuario</span>
      <div class="user-menu" id="userMenu" role="menu" aria-hidden="true">
        <a href="opciones.html" role="menuitem">Opciones</a>
        <button id="logoutMenuItem" type="button" role="menuitem">Cerrar sesión</button>
      </div>
    </div>
  </nav>
  <main>
    <div class="panel" style="margin-bottom:12px;">
      <h1>Topología / UTT — Vida Operativa</h1>
      <p class="help">Carga <code>invsistejm.csv</code>, mapea columnas y calcula si la tubería es utilizable o está fuera de rango, y su vida operativa restante.</p>

      <div class="controls" id="controls">
        <select id="colId"><option value="">ID / # Equipo</option></select>
        <select id="colTipo"><option value="">Tipo (p. ej., Tubería)</option></select>
        <select id="colUTT"><option value="">UTT (espesor medido)</option></select>
        <select id="colTmin"><option value="">Espesor mínimo permitido (Tmin)</option></select>
        <select id="colCR"><option value="">Corrosión (mm/año)</option></select>
        <select id="colFecha"><option value="">Fecha referencia (opcional)</option></select>
        <input id="fTipo" type="search" placeholder="Filtrar Tipo (ej. Tubería)" />
        <input id="crDefault" type="number" step="0.001" min="0" placeholder="CR por defecto (mm/año)" />
        <div class="full">
          <label style="display:block; font-weight:600; margin-bottom:6px">Modo de evaluación</label>
          <div class="grid2">
            <label><input type="radio" name="mode" value="tmin" checked /> UTT ≥ Tmin ⇒ Utilizable</label>
            <label><input type="radio" name="mode" value="margin" /> UTT ≥ Tmin + Margen</label>
            <label>Margen (mm): <input id="margen" type="number" step="0.01" min="0" value="0" style="height:32px; margin-left:6px; width:140px"></label>
            <label>Años vida = (UTT − Tmin) / CR</label>
          </div>
        </div>
      </div>
    </div>

    <div class="panel">
      <div class="table-wrap">
        <table class="grid" id="tbl">
          <thead>
            <tr>
              <th>ID</th>
              <th>Tipo</th>
              <th>UTT (mm)</th>
              <th>Tmin (mm)</th>
              <th>CR (mm/año)</th>
              <th>Estado</th>
              <th>Vida restante (años)</th>
            </tr>
          </thead>
          <tbody id="tbody"><tr><td class="muted" colspan="7">Cargando CSV…</td></tr></tbody>
        </table>
      </div>
    </div>
  </main>

  <script src="firebase-config.js"></script>
  <script>
    window.firebaseConfig = window.firebaseConfig || {
      apiKey: "AIzaSyCaG3KkC5q0VhNDfelH3OTTC0Qrpf7PRs4",
      authDomain: "pct-checklist.firebaseapp.com",
      projectId: "pct-checklist",
      storageBucket: "pct-checklist.firebasestorage.app",
      messagingSenderId: "573177765621",
      appId: "1:573177765621:web:7f7d58915121440cebefbc"
    };
  </script>
  <script type="module" src="firebase-init.js?v=2"></script>
  <script src="script.js?v=2"></script>
  <script>
    async function loadCSV(path){
      const res = await fetch(path, { cache: 'no-cache' });
      if (!res.ok) throw new Error('No se pudo cargar CSV');
      const text = await res.text();
      return parseCSV(text);
    }
    function parseCSV(text){
      const lines = text.replace(/\r\n?/g, '\n').split('\n').filter(l=>l.length>0);
      const rows = [];
      for (const line of lines){
        const out = []; let cur=''; let inQ=false;
        for (let i=0;i<line.length;i++){
          const ch = line[i];
          if (ch==='"'){
            if (inQ && line[i+1]==='"'){ cur+='"'; i++; }
            else { inQ = !inQ; }
          } else if (ch===',' && !inQ){ out.push(cur); cur=''; }
          else { cur+=ch; }
        }
        out.push(cur);
        rows.push(out);
      }
      const headers = rows.shift() || [];
      return { headers, rows };
    }

    const state = { headers: [], rows: [], map: {}, view: [] };

    function fillSelects(){
      const ids = ['colId','colTipo','colUTT','colTmin','colCR','colFecha'];
      ids.forEach(id=>{
        const sel = document.getElementById(id);
        sel.innerHTML = `<option value="">${sel.options[0].textContent}</option>` + state.headers.map(h=>`<option>${h}</option>`).join('');
      });
      // auto-heurística básica
      const hint = (name) => state.headers.find(h=> h.toLowerCase().includes(name));
      const setIf = (id, name) => { const h = hint(name); if (h) document.getElementById(id).value = h; };
      setIf('colId','equipo'); setIf('colId','#'); setIf('colTipo','tuber'); setIf('colUTT','utt'); setIf('colTmin','tmin'); setIf('colCR','cr');
    }

    function readNumber(v){ const n = Number(String(v).replace(',','.').trim()); return isFinite(n) ? n : null; }

    function computeRow(r){
      const get = (selId)=> { const h = document.getElementById(selId).value; const idx = state.headers.indexOf(h); return idx>=0 ? r[idx] : ''; };
      const id = get('colId');
      const tipo = get('colTipo');
      const utt = readNumber(get('colUTT'));
      const tmin = readNumber(get('colTmin'));
      let cr = readNumber(get('colCR'));
      if (cr==null || cr===0){ const d = readNumber(document.getElementById('crDefault').value); if (d!=null) cr = d; }

      const mode = (document.querySelector('input[name="mode"]:checked')||{}).value || 'tmin';
      const margen = readNumber(document.getElementById('margen').value) || 0;

      let estado = '';
      if (utt==null || tmin==null){ estado = ''; }
      else {
        const req = mode==='margin' ? (tmin + margen) : tmin;
        estado = (utt >= req) ? 'Utilizable' : 'Fuera de rango';
      }

      let vida = '';
      if (utt!=null && tmin!=null && cr!=null && cr>0){
        const years = (utt - tmin) / cr;
        vida = isFinite(years) ? Math.max(0, years).toFixed(2) : '';
      }
      return { id, tipo, utt, tmin, cr, estado, vida };
    }

    function applyFilters(rows){
      const fTipo = (document.getElementById('fTipo').value||'').toLowerCase();
      return rows.filter(x => !fTipo || String(x.tipo||'').toLowerCase().includes(fTipo));
    }

    function getHeaders(){
      return Array.from(document.querySelectorAll('thead th')).map(th => th.textContent.trim());
    }
    function render(){
      const tbody = document.getElementById('tbody');
      tbody.innerHTML='';
      let computed = state.rows.map(computeRow);
      computed = applyFilters(computed);
      if (!computed.length){ tbody.innerHTML = '<tr><td class="muted" colspan="7">Sin datos</td></tr>'; return; }
      const frag = document.createDocumentFragment();
      let rIdx = 0;
      for (const x of computed){
        const tr = document.createElement('tr');
        tr.dataset.rowIndex = String(rIdx++);
        const cells = [
          x.id||'',
          x.tipo||'',
          x.utt!=null? Number(x.utt).toFixed(2): '',
          x.tmin!=null? Number(x.tmin).toFixed(2): '',
          x.cr!=null? Number(x.cr).toFixed(3): '',
          x.estado? `<span class="pill ${x.estado==='Utilizable'?'ok':'bad'}">${x.estado}</span>`: '',
          x.vida||''
        ];
        cells.forEach((val, cIdx) => {
          const td = document.createElement('td');
          td.dataset.colIndex = String(cIdx);
          if (cIdx === 5 && x.estado) { td.innerHTML = val; } else { td.textContent = val; }
          tr.appendChild(td);
        });
        frag.appendChild(tr);
      }
      tbody.appendChild(frag);
      bindTooltips();
    }

    function bind(){
      document.getElementById('controls').addEventListener('input', render);
      document.getElementById('controls').addEventListener('change', render);
    }

    (async () => {
      try {
        const { headers, rows } = await loadCSV('invsistejm.csv');
        state.headers = headers; state.rows = rows;
        fillSelects();
        bind();
        render();
        // Enhance horizontal scroll (wheel and drag)
        const wrap = document.querySelector('.table-wrap');
        if (wrap) {
          wrap.addEventListener('wheel', (e) => {
            const dx = Math.abs(e.deltaX), dy = Math.abs(e.deltaY);
            if (dy > dx) { wrap.scrollLeft += e.deltaY; e.preventDefault(); }
          }, { passive: false });
          let isDown = false, startX = 0, startLeft = 0;
          wrap.addEventListener('mousedown', (e) => { isDown = true; startX = e.pageX; startLeft = wrap.scrollLeft; wrap.style.cursor='grabbing'; });
          wrap.addEventListener('mouseleave', () => { isDown = false; wrap.style.cursor=''; });
          wrap.addEventListener('mouseup', () => { isDown = false; wrap.style.cursor=''; });
          wrap.addEventListener('mousemove', (e) => { if (!isDown) return; const dx = e.pageX - startX; wrap.scrollLeft = startLeft - dx; });
        }
      } catch (e){
        document.getElementById('tbody').innerHTML = `<tr><td class=\"muted\" colspan=\"7\">${e.message}</td></tr>`;
      }
    })();

    function bindTooltips(){
      let tip = document.querySelector('.tip');
      if (!tip) { tip = document.createElement('div'); tip.className='tip'; tip.style.display='none'; document.body.appendChild(tip); }
      const tbody = document.getElementById('tbody');
      if (!tbody) return;
      const headers = getHeaders();
      tbody.addEventListener('mousemove', (e)=>{
        const td = e.target.closest('td');
        if (!td) { tip.style.display='none'; return; }
        const tr = td.parentElement;
        const cIdx = Number(td.dataset.colIndex||-1);
        const rIdx = Number(tr?.dataset?.rowIndex||-1);
        if (cIdx<0 || rIdx<0) { tip.style.display='none'; return; }
        const header = headers[cIdx] || '';
        const value = td.textContent || '';
        tip.innerHTML = `<strong>${header}</strong><br>${value}<br><span class=\"muted\">Fila ${rIdx+1}</span>`;
        tip.style.left = Math.min(e.clientX + 16, window.innerWidth - 220) + 'px';
        tip.style.top = Math.min(e.clientY + 16, window.innerHeight - 60) + 'px';
        tip.style.display='block';
      });
      tbody.addEventListener('mouseleave', ()=>{ const el = document.querySelector('.tip'); if (el) el.style.display='none'; });
    }
  </script>
  <div id="lockOverlay" class="lock-overlay">
    <div class="lock-card">
      <h2>Inicia sesión para continuar</h2>
      <p class="sub">Autentícate para acceder a Aproximaciones.</p>
      <div class="field"><input id="authEmail" type="email" placeholder="correo@dominio.com" autocomplete="username"></div>
      <div class="field"><input id="authPassword" type="password" placeholder="Contraseña" autocomplete="current-password"></div>
      <div class="auth-actions">
        <button id="overlayLoginEmailBtn" type="button" class="btn">Entrar</button>
        <button id="overlayResetBtn" type="button" class="btn">Restablecer</button>
      </div>
    </div>
  </div>
  <footer> <a href="https://unknownshoppers.com" target="_blank" rel="noopener noreferrer">Powered by <img src="img/logotus.jpg" alt="Unknown Shoppers" style="height:18px; vertical-align:middle"></a></footer>
</body>
</html>
